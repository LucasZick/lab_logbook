{% extends "base.html" %}

{% block content %}
<style>
    /* Estilos do Calendário (copiados de calendar_view.html) */
    .table-container { overflow-x: auto; border: 1px solid #dee2e6; border-radius: 8px; }
    .activity-grid { margin-bottom: 0; }
    .activity-grid th, .activity-grid td { text-align: center; vertical-align: middle; padding: 0.75rem 0.5rem; white-space: nowrap; min-width: 45px; }
    .activity-grid tbody tr { border-bottom: 1px solid #dee2e6; }
    .activity-grid tbody tr:hover { background-color: rgba(13, 110, 253, 0.1); }
    .student-name { text-align: left !important; font-weight: 500; min-width: 180px; position: -webkit-sticky; position: sticky; left: 0; z-index: 2; background-color: #fff; }
    .activity-grid tbody tr:hover .student-name { background-color: rgba(13, 110, 253, 0.1); }
    .activity-grid thead th:first-child { position: -webkit-sticky; position: sticky; left: 0; z-index: 3; }
    .weekend-col { background-color: #f0f2f5 !important; }
    .log-content { white-space: pre-wrap; word-wrap: break-word; }
</style>

{% if has_log_today %}
    <div class="alert alert-success" role="alert">
        <i class="fas fa-check-circle"></i> <strong>Ótimo trabalho!</strong> O seu registo de hoje já foi concluído.
    </div>
{% else %}
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle"></i> <strong>Lembrete:</strong> O seu registo de hoje ainda não foi feito.
    </div>
{% endif %}

<div class="content-card mb-4">
    <h4><i class="fas fa-plus-circle text-success"></i> Novo Registro</h4>
    <p class="text-muted">Preencha o seu diário de bordo. O campo de data já vem com o dia de hoje.</p>
    <form action="{{ url_for('main.index') }}" method="post" novalidate>
        {{ form.hidden_tag() }}
        
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.entry_date.label(class="form-label") }}
                {{ form.entry_date(class="form-control" + (" is-invalid" if form.entry_date.errors else "")) }}
                <div id="dateHelp" class="form-text text-muted"><i class="fas fa-info-circle"></i> Use o calendário para selecionar.</div>
                <div class="invalid-feedback">{% for error in form.entry_date.errors %}<span>{{ error }}</span>{% endfor %}</div>
            </div>
            <div class="col-md-6 mb-3">
                {{ form.project.label(class="form-label") }}
                {{ form.project(class="form-control" + (" is-invalid" if form.project.errors else "")) }}
                <div class="invalid-feedback">{% for error in form.project.errors %}<span>{{ error }}</span>{% endfor %}</div>
            </div>
        </div>
        <div class="mb-3">
            {{ form.tasks_completed.label(class="form-label") }}
            {{ form.tasks_completed(class="form-control" + (" is-invalid" if form.tasks_completed.errors else "")) }}
            <div class="invalid-feedback">{% for error in form.tasks_completed.errors %}<span>{{ error }}</span>{% endfor %}</div>
        </div>
        <div class="mb-3">
            {{ form.observations.label(class="form-label") }}
            {{ form.observations(class="form-control") }}
        </div>
        <div class="mb-3">
            {{ form.next_steps.label(class="form-label") }}
            {{ form.next_steps(class="form-control" + (" is-invalid" if form.next_steps.errors else "")) }}
            <div class="invalid-feedback">{% for error in form.next_steps.errors %}<span>{{ error }}</span>{% endfor %}</div>
        </div>
        
        <p>{{ form.submit(class="btn btn-success") }}</p>
    </form>
</div>

<div class="content-card mb-4">
    <h3><i class="fas fa-calendar-check"></i> Meu Calendário de Atividades</h3>
    
    <div class="d-flex justify-content-between align-items-center my-3">
        <a href="{{ url_for('main.index', ano=prev_month.ano, mes=prev_month.mes) }}" class="btn btn-outline-secondary">
            &laquo; Anterior
        </a>
        <h4>{{ current_month_name }}</h4>
        <a href="{{ url_for('main.index', ano=next_month.ano, mes=next_month.mes) }}" class="btn btn-outline-secondary">
            Próximo &raquo;
        </a>
    </div>

    <div class="table-container">
        <table class="table activity-grid">
            <thead class="table-light">
                <tr>
                    <th class="student-name">Bolsista</th>
                    {% for day_info in days_header %}
                        <th class="{% if day_info.is_weekend %}weekend-col{% endif %}">{{ day_info.day }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="student-name">{{ current_user.username }}</td>
                    {% for day_status in days_status %}
                        <td class="{% if day_status.is_weekend %}weekend-col{% endif %}">
                            {% if day_status.show_icon %}
                                {% if day_status.icon_type == 'check' %}
                                    <i class="fas fa-check-circle text-success" title="Registo feito"></i>
                                {% elif day_status.icon_type == 'times' %}
                                    <i class="fas fa-times-circle text-danger" title="Registo em falta"></i>
                                {% endif %}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="content-card">
    <h3><i class="fas fa-history"></i> Registos Detalhados de: {{ current_month_name }}</h3>
    <hr>
    {% if logs_to_display %}
        {% for log in logs_to_display %}
            <div class="log-item"> <div class="log-summary d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#log-details-{{ log.id }}" aria-expanded="false">
                    <div>
                        <strong class="text-primary">{{ log.entry_date.strftime('%d/%m/%Y') }}</strong>
                        <span class="ms-3">{{ log.project }}</span>
                        {% if log.observations %}<i class="fas fa-exclamation-triangle text-warning ms-2" title="Possui observações"></i>{% endif %}
                    </div>
                    <button class="btn btn-sm btn-light">
                        Ver Detalhes <i class="fas fa-chevron-down chevron-icon"></i>
                    </button>
                </div>
                <div class="collapse" id="log-details-{{ log.id }}">
                    <div class="log-details">
                        <p><strong><i class="fas fa-tasks text-primary"></i> Tarefas Realizadas:</strong></p>
                        <p class="log-content">{{ log.tasks_completed }}</p>
                        {% if log.observations %}
                            <p><strong><i class="fas fa-lightbulb text-primary"></i> Observações:</strong></p>
                            <p class="log-content">{{ log.observations }}</p>
                        {% endif %}
                        <p><strong><i class="fas fa-arrow-right text-primary"></i> Próximos Passos:</strong></p>
                        <p class="log-content">{{ log.next_steps }}</p>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="text-center text-muted mt-3">Nenhum registo encontrado para este período.</p>
    {% endif %}
</div>

<style>
    .log-item { border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 0.5rem; overflow: hidden; }
    .log-summary { background-color: #fff; padding: 0.75rem 1.25rem; cursor: pointer; transition: background-color 0.2s; }
    .log-summary:hover { background-color: #f8f9fa; }
    .log-details { background-color: #f8f9fa; padding: 1.25rem; border-top: 1px solid #dee2e6; }
    .log-summary[aria-expanded="true"] .chevron-icon { transform: rotate(180deg); }
    .chevron-icon { transition: transform 0.2s ease-in-out; }
</style>

{% endblock %}