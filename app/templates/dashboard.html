{% extends "base.html" %}

{% block content %}
<style>
    .action-buttons .btn { margin-left: 0.5rem; }
    .flatpickr-input {
        background-color: #fff; /* Garante fundo branco como outros inputs */
    }
</style>

<div class="content-card mb-4">
    <h3><i class="fas fa-tachometer-alt"></i> Painel do Professor</h3>
    <p class="text-muted">Gerencie as solicitações de registro e o status dos bolsistas.</p>
    
    <hr>
    <form action="{{ url_for('main.search') }}" method="get" class="d-flex mt-3">
        <input class="form-control me-2" type="search" name="q" placeholder="Buscar em todos os diários..." aria-label="Search" value="{{ request.args.get('q', '') }}">
        <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i> Buscar</button>
    </form>
</div>


<div class="content-card mb-4">
    <h4><i class="fas fa-brain"></i> Análise de Desempenho com IA</h4>
    <p class="text-muted">Gere relatórios semanais ou mensais com base nos registos dos bolsistas ativos.</p>
    <hr>
    
    <div class="row">

        <!-- Coluna da Esquerda: Relatório Semanal -->
        <div class="col-md-6 border-end">
            <h5 class="text-center">Relatório Semanal</h5>
            <p class="text-muted text-center small">Selecione um dia qualquer. O relatório incluirá a semana inteira (Seg-Dom) desse dia.</p>
            
            <form action="{{ url_for('main.generate_report') }}" method="get" id="form-weekly-report">
                <div class="mb-3">
                    <label for="report_date_week" class="form-label">Data de Referência:</label>
                    <input type="date" class="form-control" id="report_date_week" name="selected_date" value="{{ today_date }}">
                </div>
                <button type="submit" class="btn btn-info w-100" id="btn-weekly-report">
                    <i class="fas fa-calendar-week"></i> Gerar Relatório Semanal
                </button>
            </form>
        </div>

        <!-- Coluna da Direita: Relatório Mensal -->
        <div class="col-md-6">
            <h5 class="text-center">Relatório Mensal</h5>
            <p class="text-muted text-center small">Selecione o mês e o ano desejados para a análise completa do período.</p>
            
            <form action="{{ url_for('main.generate_report') }}" method="get" id="form-monthly-report">
                <input type="hidden" name="report_type" value="month">
                <div class="row g-2">
                    <div class="col-sm-7">
                        <label for="month_num" class="form-label">Mês:</label>
                        <select class="form-select" id="month_num" name="month_num">
                            {% for num, nome in meses.items() %}
                                <option value="{{ num }}" {% if num == current_month_num %}selected{% endif %}>{{ nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-sm-5">
                        <label for="year_select" class="form-label">Ano:</label>
                        <select class="form-select" id="year_select" name="year">
                            {% for y in available_years %}
                                <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100 mt-3" id="btn-monthly-report">
                    <i class="fas fa-chart-line"></i> Gerar Relatório Mensal
                </button>
            </form>
        </div>
        
    </div>
</div>

<div class="content-card mb-4">
    <h4><i class="fas fa-user-clock"></i> Solicitações de Registro Pendentes</h4>
    {% if pending_users %}
        <ul class="list-group">
            {% for user in pending_users %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>{{ user.username }}</strong> <small class="text-muted">({{ user.email }})</small></span>
                <div class="action-buttons">
                    <a href="{{ url_for('main.approve_user', user_id=user.id) }}" class="btn btn-sm btn-success"><i class="fas fa-check"></i> Aprovar</a>
                    <a href="{{ url_for('main.reject_user', user_id=user.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Tem certeza?');"><i class="fas fa-times"></i> Rejeitar</a>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">Nenhuma solicitação pendente.</p>
    {% endif %}
</div>

<div class="content-card mb-4">
    <h4><i class="fas fa-users"></i> Bolsistas Ativos</h4>
    {% if active_bolsistas %}
        <ul class="list-group">
            {% for bolsista in active_bolsistas %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>{{ bolsista.username }}</strong></span>
                <div class="action-buttons">
                    <a href="{{ url_for('main.view_logs', student_id=bolsista.id) }}" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> Ver Diário</a>
                    <a href="{{ url_for('main.deactivate_user', user_id=bolsista.id) }}" class="btn btn-sm btn-warning" onclick="return confirm('Tem certeza?');"><i class="fas fa-user-slash"></i> Desativar</a>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">Nenhum bolsista ativo no momento.</p>
    {% endif %}
</div>

<div class="content-card">
    <h4><i class="fas fa-user-lock"></i> Bolsistas Inativos</h4>
    {% if inactive_bolsistas %}
        <ul class="list-group">
            {% for bolsista in inactive_bolsistas %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>{{ bolsista.username }}</strong></span>
                <div class="action-buttons">
                    <a href="{{ url_for('main.view_logs', student_id=bolsista.id) }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-eye"></i> Ver Histórico</a>
                    <a href="{{ url_for('main.activate_user', user_id=bolsista.id) }}" class="btn btn-sm btn-info" onclick="return confirm('Tem certeza?');"><i class="fas fa-user-check"></i> Reativar</a>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">Nenhum bolsista inativo.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }} <!-- Inclui scripts do base.html, se houver -->

<!-- SCRIPT DE LOADING (CORREÇÃO FINAL E ROBUSTA) -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- LÓGICA PARA O BOTÃO SEMANAL ---
        const weeklyButton = document.getElementById('btn-weekly-report');
        if (weeklyButton) {
            // 1. Ouvir o 'click' do BOTÃO
            weeklyButton.addEventListener('click', function(event) {
                // 2. Impedir a submissão padrão imediata
                event.preventDefault(); 
                
                // 3. Mudar o botão para 'loading'
                this.disabled = true; // 'this' é o botão
                this.innerHTML = `
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    A gerar...
                `;

                // 4. Encontrar o formulário a que este botão pertence
                const form = this.closest('form'); 

                // 5. Agendar a submissão real para daqui a 50ms
                setTimeout(() => {
                    form.submit(); // Submete o formulário
                }, 50); 
            });
        }

        // --- LÓGICA PARA O BOTÃO MENSAL ---
        const monthlyButton = document.getElementById('btn-monthly-report');
        if (monthlyButton) {
            // 1. Ouvir o 'click' do BOTÃO
            monthlyButton.addEventListener('click', function(event) {
                // 2. Impedir a submissão padrão imediata
                event.preventDefault();

                // 3. Mudar o botão para 'loading'
                this.disabled = true; // 'this' é o botão
                this.innerHTML = `
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    A gerar...
                `;
                
                // 4. Encontrar o formulário a que este botão pertence
                const form = this.closest('form');

                // 5. Agendar a submissão real para daqui a 50ms
                setTimeout(() => {
                    form.submit();
                }, 1000);
            });
        }
    });
</script>
{% endblock %}