{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Estilos Específicos do Dashboard */
    .stat-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-icon {
        width: 48px; height: 48px;
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem;
    }
    .avatar-sm { width: 32px; height: 32px; object-fit: cover; }
    .table-hover tbody tr:hover { background-color: rgba(1, 85, 43, 0.03); }
    .action-buttons .btn { margin-left: 0.5rem; }
    
    /* Header Actions */
    .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: flex-end;
        flex-wrap: wrap;
    }
</style>

<div class="row mb-4 align-items-center">
    <div class="col-md-5">
        <h2 class="fw-bold text-dark mb-1">
            Olá, <span style="color: #01552b;">{{ current_user.username }}</span>!
        </h2>
        <p class="text-muted mb-0">Aqui está o panorama do laboratório hoje.</p>
    </div>
    
    <div class="col-md-7">
        <div class="header-actions">
            <a href="{{ url_for('main.tv_mode') }}" class="btn btn-dark" title="Ativar Modo Apresentação">
                <i class="fas fa-tv me-2"></i> Modo TV
            </a>

            <a href="{{ url_for('main.invite_member') }}" class="btn btn-outline-primary">
                <i class="fas fa-paper-plane me-2"></i> Convidar Membro
            </a>

            <form action="{{ url_for('main.search') }}" method="get" class="d-flex" style="max-width: 300px;">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input class="form-control border-start-0 ps-0" type="search" name="q" placeholder="Pesquisar..." value="{{ request.args.get('q', '') }}">
                    <button class="btn btn-primary" type="submit">Ir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="content-card p-3 mb-3 stat-card" style="border-color: #22c55e;">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-success bg-opacity-10 text-success me-3"><i class="fas fa-users"></i></div>
                <div><h6 class="text-muted mb-0">Bolsistas Ativos</h6><h3 class="fw-bold mb-0">{{ active_bolsistas|length }}</h3></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="content-card p-3 mb-3 stat-card" style="border-color: #f59e0b;">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3"><i class="fas fa-user-clock"></i></div>
                <div><h6 class="text-muted mb-0">Solicitações Pendentes</h6><h3 class="fw-bold mb-0">{{ pending_users|length }}</h3></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="content-card p-3 mb-3 stat-card" style="border-color: #64748b;">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-secondary bg-opacity-10 text-secondary me-3"><i class="fas fa-user-lock"></i></div>
                <div><h6 class="text-muted mb-0">Bolsistas Inativos</h6><h3 class="fw-bold mb-0">{{ inactive_bolsistas|length }}</h3></div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="content-card h-100 p-4">
            <h5 class="fw-bold text-dark mb-4"><i class="fas fa-chart-bar text-primary me-2"></i> Atividade Recente (7 Dias)</h5>
            <div style="height: 250px;"><canvas id="activityChart"></canvas></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="content-card h-100 p-4">
            <h5 class="fw-bold text-dark mb-4"><i class="fas fa-chart-pie text-success me-2"></i> Top Projetos (30 dias)</h5>
            <div style="height: 200px; display: flex; justify-content: center;"><canvas id="projectsChart"></canvas></div>
        </div>
    </div>
</div>

<div class="row">
    
    <div class="col-lg-8">
        <div class="content-card mb-4">
            <div class="d-flex align-items-center mb-3">
                <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3" style="width: 40px; height: 40px; font-size: 1.2rem;">
                    <i class="fas fa-robot"></i>
                </div>
                <h4 class="mb-0">Gerador de Relatórios IA</h4>
            </div>
            
            <div class="row g-4">
                <div class="col-md-6 border-end">
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Análise Semanal</h6>
                    
                    <form action="{{ url_for('main.generate_report') }}" method="get" onsubmit="showLoading('btn-weekly-report')">
                        <div class="mb-3">
                            <label class="form-label small">Selecione um dia de referência</label>
                            <input type="date" class="form-control" name="selected_date" value="{{ today_date }}">
                        </div>
                        <button type="submit" class="btn btn-outline-primary w-100" id="btn-weekly-report">
                            <i class="fas fa-magic me-2"></i> Gerar Relatório da Semana
                        </button>
                    </form>
                </div>

                <div class="col-md-6">
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Análise Mensal</h6>
                    
                    <form action="{{ url_for('main.generate_report') }}" method="get" onsubmit="showLoading('btn-monthly-report')">
                        <input type="hidden" name="report_type" value="month">
                        <div class="row g-2 mb-3">
                            <label class="form-label small">Selecione o mês</label>
                            <div class="col-8">
                                <select class="form-select" name="month_num">
                                    {% for num, nome in meses.items() %}
                                        <option value="{{ num }}" {% if num == current_month_num %}selected{% endif %}>{{ nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-4">
                                <select class="form-select" name="year">
                                    {% for y in available_years %}
                                        <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-outline-success w-100" id="btn-monthly-report">
                            <i class="fas fa-chart-pie me-2"></i> Gerar Relatório do Mês
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="content-card">
            <h4 class="mb-4">Equipe Ativa</h4>
            {% if active_bolsistas %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>Nome</th><th>Curso</th><th class="text-end">Ações</th></tr></thead>
                        <tbody>
                            {% for bolsista in active_bolsistas %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ url_for('static', filename='profile_pics/' + bolsista.image_file) }}" class="avatar-sm rounded-circle me-2">
                                        <span class="fw-bold">{{ bolsista.username }}</span>
                                    </div>
                                </td>
                                <td class="text-muted small">{{ bolsista.course or '-' }}</td>
                                <td class="text-end">
                                    <a href="{{ url_for('main.view_logs', student_id=bolsista.id) }}" class="btn btn-sm btn-light text-primary" title="Ver Diário"><i class="fas fa-eye"></i></a>
                                    <a href="{{ url_for('main.deactivate_user', user_id=bolsista.id) }}" class="btn btn-sm btn-light text-warning" onclick="return confirm('Desativar?');" title="Desativar"><i class="fas fa-pause"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state py-4"><i class="fas fa-users text-muted mb-2" style="font-size: 2rem;"></i><p class="text-muted mb-0">Sem bolsistas ativos.</p></div>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-4">
        {% if pending_users %}
        <div class="content-card mb-4 border-warning">
            <h5 class="text-warning mb-3"><i class="fas fa-bell me-2"></i> Pendentes</h5>
            <ul class="list-group list-group-flush">
                {% for user in pending_users %}
                <li class="list-group-item px-0 border-0">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <img src="{{ url_for('static', filename='profile_pics/' + user.image_file) }}" class="avatar-sm rounded-circle me-2">
                            <div style="line-height: 1.2;"><small class="d-block fw-bold">{{ user.username }}</small><small class="text-muted" style="font-size: 0.75rem;">{{ user.email }}</small></div>
                        </div>
                        <div>
                            <a href="{{ url_for('main.approve_user', user_id=user.id) }}" class="btn btn-sm btn-success py-0 px-2"><i class="fas fa-check"></i></a>
                            <a href="{{ url_for('main.reject_user', user_id=user.id) }}" class="btn btn-sm btn-danger py-0 px-2" onclick="return confirm('Rejeitar?');"><i class="fas fa-times"></i></a>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#inactiveList" style="cursor: pointer;">
                <h5 class="mb-0 text-muted"><i class="fas fa-archive me-2"></i> Arquivo / Inativos</h5>
                <i class="fas fa-chevron-down text-muted"></i>
            </div>
            
            <div class="collapse mt-3" id="inactiveList">
                {% if inactive_bolsistas %}
                    <ul class="list-group list-group-flush">
                        {% for bolsista in inactive_bolsistas %}
                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <span class="text-muted">{{ bolsista.username }}</span>
                            <div>
                                <a href="{{ url_for('main.view_logs', student_id=bolsista.id) }}" class="text-secondary me-2"><i class="fas fa-history"></i></a>
                                <a href="{{ url_for('main.activate_user', user_id=bolsista.id) }}" class="text-success" onclick="return confirm('Reativar?');"><i class="fas fa-undo"></i></a>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted small mb-0 mt-2">Nenhum registro.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Esta função é chamada diretamente pelo 'onsubmit' do formulário
    function showLoading(btnId) {
        const btn = document.getElementById(btnId);
        if (btn) {
            // Mudar o texto e adicionar o spinner
            const originalWidth = btn.offsetWidth; // Mantém a largura para não pular
            btn.style.width = `${originalWidth}px`;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>A processar...';
            
            // Adiciona uma classe visual de desabilitado, mas NÃO usa o atributo 'disabled'
            // (porque 'disabled' pode impedir o submit em alguns navegadores se for rápido demais)
            btn.classList.add('disabled');
            btn.style.pointerEvents = 'none';
        }
        // Retorna true para permitir que o formulário seja enviado normalmente
        return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Gráficos (Mantidos iguais)
        const ctxActivity = document.getElementById('activityChart');
        if (ctxActivity) {
            new Chart(ctxActivity.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: {{ dates_labels | tojson }},
                    datasets: [{
                        label: 'Registros',
                        data: {{ dates_counts | tojson }},
                        backgroundColor: '#01552b',
                        borderRadius: 4,
                        barThickness: 30
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5] } }, x: { grid: { display: false } } } }
            });
        }

        const ctxProjects = document.getElementById('projectsChart');
        if (ctxProjects) {
            new Chart(ctxProjects.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: {{ project_labels | tojson }},
                    datasets: [{
                        data: {{ project_counts | tojson }},
                        backgroundColor: ['#01552b', '#10b981', '#3b82f6', '#f59e0b', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } } }
            });
        }
    });
</script>
{% endblock %}